# 电商商品详情页图片生成流程

## Context

为电商卖家构建一个自动化工具: 输入同款不同色的平铺衣服图 + 真人模特参考照, 自动生成模特穿着图(正面/反面), 再拼接成电商详情页长图。使用 Nano Banana Pro API (laozhang.ai 代理) + Node.js 实现。

---

## 一、整体流程架构

```
输入层                  生成层(Step1)               生成层(Step2)                输出层
┌─────────────┐     ┌──────────────────┐     ┌──────────────────────┐     ┌──────────┐
│ 平铺衣服图   │     │  模特正面穿着图    │     │                      │     │          │
│ (多色, N张)  │────▶│  (每色1张)        │────▶│  详情页分段图          │     │ 电商详情  │
│             │     │                  │     │  (每张参考图对应1张)   │────▶│ 页长图    │
│ 模特参考照   │────▶│  模特反面穿着图    │     │                      │     │ (拼接)   │
│(正面+背面各1)│     │  (每色1张)        │     │                      │     │          │
├─────────────┤     └──────────────────┘     └──────────────────────┘     └──────────┘
│ 详情页参考图  │                                       ▲
│ (分割的N张)  │───────────────────────────────────────┘
└─────────────┘

姿势参考图 (固定资源, 不需上传):
  poses/             ← 项目根目录下, 预置多张姿势参考照
  ├── pose-01.jpg
  ├── pose-02.jpg
  └── ...
  生成时随机选一张作为姿势参考, 与模特照+衣服图一起发给 API
```

**数据流 (交互式, 每步暂停确认):**
1. **输入处理** → 读取所有图片 (衣服图、模特照、详情页参考图), 转 base64, 校验
2. **Step1: 模特穿着图生成** → 每色调用 API (平铺图 + 模特照 → 正面/反面穿着图)
   - ⏸ **暂停确认**: 展示所有生成结果, 可按编号选择单张重新生成, 直到全部通过
3. **Step2: 详情页分段生成** → 逐张参考图调用 API (参考图 + 模特穿着图 → 生成对应的详情页段落图)
   - ⏸ **逐张确认**: 每张生成后立即预览, 可单独重新生成, 通过后进入下一张
4. **拼接输出** → 将所有详情页分段图用 sharp 按顺序纵向拼接成完整长图

> Step1: 同色正面/反面串行, 不同颜色可并行。生成完毕后统一审核。
> Step2: 逐张生成+确认, 最后按参考图顺序拼接。

---

## 一(附)、交互式审核流程

### Step1 审核 (批量模式)

生成所有模特穿着图后, 统一展示并审核:
```
[Step1 审核] 已保存到 output/step1/, 已打开预览
  1. black-front.jpg  2. black-back.jpg
  3. white-front.jpg  4. white-back.jpg

操作: [a] 全部通过  [数字] 重新生成指定图  [q] 退出
> 3            ← 重新生成第3张
> a            ← 全部通过, 进入 Step2
```

### Step2 审核 (逐张模式)

每张详情页段落图生成后, 立即审核:
```
生成中: section-01.jpg ... ✓ (已打开预览)
操作: [a] 通过  [r] 重新生成
> a            ← 通过, 自动开始下一张

生成中: section-02.jpg ... ✓ (已打开预览)
操作: [a] 通过  [r] 重新生成
> r            ← 不满意, 重新生成
重新生成中... ✓
> a            ← 通过
```

---

## 二、API 调用规范

**Endpoint:** `https://api.laozhang.ai/v1beta/models/gemini-3-pro-image-preview:generateContent`

**请求结构:**
```json
{
  "contents": [{
    "parts": [
      { "text": "prompt 文本" },
      { "inline_data": { "mime_type": "image/jpeg", "data": "<模特参考照 base64 (正面生成用正面照, 反面生成用背面照)>" } },
      { "inline_data": { "mime_type": "image/jpeg", "data": "<平铺衣服图 base64>" } },
      { "inline_data": { "mime_type": "image/jpeg", "data": "<姿势参考照 base64 (从 poses/ 随机选取)>" } }
    ]
  }],
  "generationConfig": {
    "responseModalities": ["IMAGE"],
    "imageConfig": {
      "aspectRatio": "3:4",
      "imageSize": "2K"
    }
  }
}
```

**关键参数:**
- 纵横比: `3:4` (适合电商模特图竖版)
- 分辨率: `2K` (平衡质量和速度)
- 每次请求约 $0.05, 耗时 5-15s

---

## 三、Prompt 工程 (核心)

### 3.1 正面穿着图 Prompt 模板

> 输入图片: 模特**正面**参考照 + 平铺衣服图

```
你是一位专业的电商时尚摄影师。

我提供了三张图片:
1. 模特的正面参考照 - 你必须生成一个与该模特完全一致的人 (相同的脸型、体型、肤色、发型)
2. 一张衣服的平铺图 - 这是一件 {clothing_type}, 颜色为 {color}
3. 一张姿势参考照 - 模特需要采用与这张照片相同的站姿和肢体动作

生成一张专业的电商产品照片, 要求模特:
- 穿着与平铺图完全一致的衣服 (匹配所有细节: 面料质感、图案花纹、纽扣、拉链、走线、领型、袖长)
- 采用与姿势参考照相同的站姿和肢体动作, 但面朝正前方 (正面视角)
- 手臂微微张开远离身体, 让衣服轮廓清晰可见
- 直视镜头, 表情自然自信

拍摄要求:
- 干净的白色/浅灰色影棚背景
- 柔和均匀的影棚灯光, 无明显阴影
- 全身照, 从头部到膝盖以下
- 衣服细节清晰锐利
- 专业电商摄影风格 (类似 ZARA、UNIQLO 产品页)

关键: 衣服必须与平铺图完全匹配 - 相同颜色、相同面料、相同设计细节。模特必须与参考照看起来完全一致。
```

### 3.2 反面穿着图 Prompt 模板

> 输入图片: 模特**背面**参考照 + 平铺衣服图

```
你是一位专业的电商时尚摄影师。

我提供了三张图片:
1. 模特的背面参考照 - 你必须从背后生成与该模特完全一致的人 (相同的体型、肤色、发型、身体比例)
2. 一张衣服的平铺图 - 这是一件 {clothing_type}, 颜色为 {color}
3. 一张姿势参考照 - 模特需要采用与这张照片相似的站姿, 但从背面呈现

生成一张专业的电商产品照片, 要求模特:
- 穿着与平铺图完全一致的衣服 (匹配所有细节: 面料质感、图案花纹、背部设计、走线)
- 背对镜头站立 (背面视角 / 后视图), 采用与姿势参考照相似的肢体动作
- 自然站立姿势, 头部可微微侧转以表明是同一位模特
- 双臂自然下垂, 让衣服背面完全可见

拍摄要求:
- 干净的白色/浅灰色影棚背景 (与正面图一致)
- 柔和均匀的影棚灯光, 无明显阴影
- 全身照, 从头部到膝盖以下
- 衣服背面细节清晰锐利
- 专业电商摄影风格

关键: 衣服必须与平铺图完全匹配。模特必须与参考照是同一个人。这是同一套服装正面图的背面视角。
```

### 3.3 Prompt 变量

| 变量 | 说明 | 示例 |
|------|------|------|
| `{clothing_type}` | 衣服类型 | t-shirt, hoodie, jacket, dress |
| `{color}` | 颜色描述 | black, navy blue, cream white |
| `{additional_notes}` | 额外说明 (可选) | oversized fit, cropped length |

### 3.4 Prompt 策略说明

- **模特照放在衣服图前面**: 让模型优先理解"这个人长什么样", 再理解"穿什么衣服"
- **正面/背面分别用对应参考照**: 正面生成用模特正面照, 反面生成用模特背面照, 提高角度匹配准确度
- **强调 EXACTLY / IDENTICAL**: 防止 AI 自由发挥改变衣服细节或模特外观
- **明确摄影风格**: 用具体品牌参考 (ZARA/UNIQLO) 让 AI 理解电商风格
- **全身照要求**: 避免生成半身或特写

---

## 四、详情页生成 (Step2)

### 4.1 工作原理

用户提供一套**详情页参考图** (已按顺序分割好的 N 张图), 每张参考图代表详情页的一个段落/区块。

对每张参考图:
- 将参考图 + 相关的模特穿着图一起发给 API
- Prompt 指示 AI: "参照这张详情页设计, 用我提供的模特穿着图替换其中的模特/产品图, 保持整体排版和风格不变"
- API 返回生成的详情页段落图

### 4.2 详情页参考图说明

```
input/detail-refs/
├── 01.jpg    ← 详情页第1段 (如: 封面主图区)
├── 02.jpg    ← 详情页第2段 (如: 颜色展示区)
├── 03.jpg    ← 详情页第3段 (如: 细节特写区)
├── ...
└── 0N.jpg    ← 详情页第N段
```

- 参考图按文件名排序, 决定最终拼接顺序
- 每张参考图宽度应为 790px (或由程序统一 resize)
- 参考图来源: 已有的其他商品详情页, 或设计师制作的模板

### 4.3 详情页段落生成 Prompt 模板

```
你是一位专业的电商平面设计师。

我提供了以下图片:
1. 一张详情页参考图 - 展示了你必须遵循的排版、风格和设计
2. 模特穿着照片 - 这些是需要用在生成图片中的产品照片

生成一张新的电商详情页段落图, 要求:
- 严格遵循参考图的排版布局、构图和视觉风格
- 将参考图中的模特/产品图替换为我提供的模特穿着照片
- 保持相同的背景风格、配色方案和整体美感
- 保持相同的比例和间距
- 宽度必须为 790px

关键: 排版和设计风格必须与参考图高度一致。只有模特/产品图片需要更换。保持专业电商详情页的美感。
```

### 4.4 最终拼接

所有段落图生成后, 使用 **sharp** 按顺序纵向拼接:
- 宽度统一 resize 到 790px
- 纵向无缝拼接
- 输出最终长图

### 4.5 合成库: sharp
- 高性能 Node.js 图片处理库
- 仅用于最终拼接 (resize + vertical join), 不做复杂合成
- 比 canvas 更轻量, 不依赖系统 GUI 库

---

## 五、项目结构

```
product-detail-images/
├── package.json
├── .env                      # API_KEY 等配置
├── config/
│   └── default.js            # 默认配置 (分辨率、宽比、模板尺寸等)
├── src/
│   ├── index.js              # 入口: 编排整个流程
│   ├── api/
│   │   └── nanoBanana.js     # Nano Banana Pro API 封装
│   ├── prompts/
│   │   └── templates.js      # prompt 模板 (正面/反面)
│   ├── generator/
│   │   └── modelImage.js     # 模特穿着图生成逻辑
│   ├── composer/
│   │   └── detailPage.js     # 长图拼接合成
│   └── utils/
│       └── image.js          # 图片工具 (base64转换、尺寸处理)
├── input/                    # 输入图片目录
│   ├── model/
│   │   ├── front.jpg         # 模特正面参考照
│   │   └── back.jpg          # 模特背面参考照
│   ├── clothes/              # 平铺衣服图 (按颜色命名)
│   └── detail-refs/          # 详情页参考图 (按顺序命名: 01.jpg, 02.jpg, ...)
└── output/                   # 生成结果输出
```

---

## 六、核心模块职责

| 模块 | 职责 |
|------|------|
| `nanoBanana.js` | API 调用封装, 重试逻辑, base64 响应解析 |
| `templates.js` | prompt 模板管理, 变量替换 |
| `modelImage.js` | 编排单色的正面+反面生成, 多色并发控制 |
| `detailPage.js` | Step2: 逐张参考图调用 API 生成详情页段落, 再用 sharp 拼接成长图 |
| `image.js` | 图片读取/base64编码/尺寸调整 |
| `index.js` | CLI 入口, 读取输入目录, 调用各模块, 输出结果 |

---

## 七、错误处理与成本

### 错误处理
- API 调用失败: 最多重试 3 次, 指数退避 (2s → 4s → 8s)
- 并发控制: 最多 3 个颜色同时生成 (避免 rate limit)
- 生成结果校验: 检查返回是否包含有效 image data

### 成本估算
- Step1 模特图: 每色 2 张 (正+反) = $0.10/色
- Step2 详情页: 每张参考图 1 次调用 = $0.05/段
- 示例: 5 色 + 8 段详情页 = $0.50 + $0.40 = **$0.90/款**

### 时间估算
- Step1 单色: ~20-30s (正面 + 反面串行)
- Step1 5色(3并发): ~40-60s
- Step2 8段详情页(3并发): ~30-45s
- 拼接: ~2-3s
- **总计: ~1.5-2 分钟/款**

---

## 八、依赖

```json
{
  "dependencies": {
    "sharp": "^0.33.x",
    "dotenv": "^16.x",
    "p-limit": "^6.x"
  }
}
```

---

## 九、验证方式

1. 准备 1 张模特参考照 + 2-3 色平铺衣服图
2. 运行流程, 检查:
   - 生成的模特图是否与参考照一致 (脸型/肤色/体型)
   - 衣服是否与平铺图匹配 (颜色/款式/细节)
   - 正面/反面角度是否正确
   - 长图拼接是否整齐, 尺寸是否符合电商规范
3. 迭代优化 prompt 直到质量满意

---

## 十、Web 界面

提供一个简单的 HTML 页面 (本地 HTTP 服务), 替代 CLI 交互:

### 10.1 功能

1. **上传区**: 上传模特参考照 (正面/背面)、平铺衣服图 (多色)、详情页参考图 (多张)
2. **生成控制**: 点击按钮触发 Step1/Step2 生成
3. **结果预览**: 生成的图片直接在页面展示, 每张图有「重新生成」按钮
4. **确认流程**: 逐张确认/重新生成, 全部通过后进入下一步
5. **最终下载**: 拼接完成后提供长图下载

### 10.2 技术方案

- 后端: Node.js 内置 `http` 模块 (或轻量 express), 提供 API 接口
- 前端: 单个 `public/index.html`, 原生 HTML + JS, 无框架
- 通信: fetch API 调用后端接口
- 图片预览: 后端返回 base64 或保存到 `output/` 后返回文件路径

### 10.3 页面布局

```
┌──────────────────────────────────────────────┐
│  电商详情页图片生成工具                         │
├──────────────────────────────────────────────┤
│                                              │
│  [上传区]                                     │
│  模特正面照: [选择文件]  模特背面照: [选择文件]   │
│  平铺衣服图: [选择多个文件]                      │
│  详情页参考图: [选择多个文件]                     │
│                                              │
│  衣服类型: [下拉选择]  [开始生成 Step1]          │
│                                              │
├──────────────────────────────────────────────┤
│  [Step1 结果]                                 │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐            │
│  │黑-正 │ │黑-反 │ │白-正 │ │白-反 │           │
│  │ [重生]│ │ [重生]│ │ [重生]│ │ [重生]│          │
│  └─────┘ └─────┘ └─────┘ └─────┘            │
│                     [全部通过, 开始 Step2]      │
│                                              │
├──────────────────────────────────────────────┤
│  [Step2 结果]                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐     │
│  │ 段落1     │ │ 段落2     │ │ 段落3     │    │
│  │  [重生]   │ │  [重生]   │ │  [重生]   │    │
│  └──────────┘ └──────────┘ └──────────┘     │
│                     [全部通过, 拼接长图]        │
│                                              │
├──────────────────────────────────────────────┤
│  [最终结果]                                    │
│  ┌─────────────────────┐                     │
│  │    长图预览 (缩略)    │   [下载长图]         │
│  └─────────────────────┘                     │
└──────────────────────────────────────────────┘
```

### 10.4 项目结构更新

```
├── src/
│   ├── server.js             # HTTP 服务, API 路由
│   └── ...
├── public/
│   └── index.html            # 前端页面
```

---

## 十一、后续优化方向 (不在本期范围)

- 支持更多姿势配置
- 支持自动生成商品文案
- 支持批量处理多款商品
